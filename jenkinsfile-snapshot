#!/usr/bin/env groovy

// Use node dedicated to Java compilation
pipeline {
    agent any
    /*tools {
        //jdk 'jdk8'
        maven 'maven3'
    }*/
    stages {
        // Clean workspace

        stage('test java installation') {
            steps {
                echo 'Checking Java Version..'
                sh 'java -version'
                sh 'which java'
            }
        }
        stage('test maven installation') {
            steps {
                echo 'Checking Maven Version..'
                sh 'mvn -version'
                sh 'which mvn'
            }
        }
        stage('Clean workspace') {
            steps {
                println("deleteDir")
                deleteDir()
            }

        }
        // Download source code
        stage('Preparation') {
            steps {
                println("checkout scm")
                checkout scm
            }
        }

        // Launch Maven
        stage('Build') {
            steps {
                println("Running Build")
                mavenTask("clean install")

                // Tell Mailer that it's a success

            }

        }

    }

}

def mavenTask(String command) {
    def MAVEN_BUILD=tool 'maven3'
    //def JAVA_HOME=tool 'JDK_1.8.0_121'
    def NODE_HOME=tool 'node'

    if (isUnix()) {
        sh "'${MAVEN_BUILD}/bin/mvn' -e -U -B -X  ${command}"
    } else {
        withEnv(["JAVA_HOME=${JAVA_HOME}",
                 "PATH=${NODE_HOME};${env.PATH};${WORKSPACE}/spring-boot-angular-jenkins-web/node-modules/.bin"]) {
            bat (/"${MAVEN_BUILD}\bin\mvn.bat" -e -U -B ${command}/)
        }
    }
}
